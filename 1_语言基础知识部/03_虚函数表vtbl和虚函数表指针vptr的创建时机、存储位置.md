# 问题：虚函数表vtbl和虚函数表指针vptr的创建时机、存储位置？

**虚函数表**：虚函数表vtbl是编译器`在编译阶段生成的`，当一个类中包含虚函数时，编译器会为该类生成一个虚函数表，保存该类中虚函数的地址。派生类继承基类过程中，派生类中一定会有虚函数，所以编译器也会为派生类生成自己的虚函数表。一旦生成则无法改变。存储的位置是内存模型中的`常量区`。因为栈区和堆区是在程序运行阶段才有的、代码区是存放源码的、全局区可以修改，所以只能在常量区。`虚函数表是跟着类一起走的`，每个类会有一个虚函数表。

**虚函数表指针**：虚函数表指针vptr是`创建类对象时生成的`，编译器会在构造函数中添加一个虚函数表指针的初始化过程，占用4或8个字节。`虚函数表指针是跟着类对象一起走的`。存储位置可能在堆区或栈区，new是在堆区，否则是在栈区。

```c++
#include <iostream>
using namespace std;

class Base {
public:
    Base() {
        // 构造类对象时，编译器自动添加虚函数表指针vptr
    }
    virtual void func() {
        cout << "Base!" << endl;
    }
};

class Derived : public Base {
public:
    Derived() {
        // 构造类对象时，编译器自动添加虚函数表指针vptr
    }
    virtual void func() {
        cout << "Derived!" << endl;
    }
};
```

